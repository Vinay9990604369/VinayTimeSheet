{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>Timesheet Entry</h2>

<!-- Filters on top -->
<form method="get" action="{% url 'core:timesheet_entry' %}" style="margin-bottom: 1rem;">
  <label for="client">Client:</label>
  <select id="client" name="client" required class="form-control">
    <option value="">-- Select Client --</option>
    {% for client in clients %}
    <option value="{{ client.id }}" {% if client.id|stringformat:"s" == selected_client_id %}selected{% endif %}>
      {{ client.company_name }}
    </option>
    {% endfor %}
  </select>

  <label for="project">Project:</label>
  <select id="project" name="project" required class="form-control">
    <option value="">-- Select Project --</option>
    {% for project in projects %}
    <option value="{{ project.id }}" {% if project.id|stringformat:"s" == selected_project_id %}selected{% endif %}>
      {{ project.name }}
    </option>
    {% endfor %}
  </select>

  <label for="month">Month:</label>
  <input
    type="month"
    id="month"
    name="month"
    value="{{ selected_month }}"
    required
    class="form-control"
  />

  <button type="submit" class="button button-primary">Load Timesheet</button>
</form>

{% if timesheet_entries %}
<form method="post" novalidate>
  {% csrf_token %}
  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Client</th>
        <th>Client ID</th>
        <th>Project</th>
        <th>Project ID</th>
        <th>Service Provider</th>
        <th>Service Type</th>
        <th>Phase</th>
        <th>Billing Consultant</th>
        <th>Last Updated</th>
        <th>Billing Time Duration (hrs)</th>
        <th>Work Description</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in timesheet_entries %}
      <tr>
        <td>{{ entry.date_of_service|date:"Y-m-d" }}</td>
        <td><input type="text" value="{{ entry.client.company_name }}" readonly class="form-control" /></td>
        <td><input type="text" value="{{ entry.client.client_id }}" readonly class="form-control" /></td>
        <td><input type="text" value="{{ entry.project.name }}" readonly class="form-control" /></td>
        <td><input type="text" value="{{ entry.project.project_id }}" readonly class="form-control" /></td>
        <td><input type="text" value="{{ entry.project.service_provider }}" readonly class="form-control" /></td>
        <td><input type="text" value="{{ entry.project.service_type }}" readonly class="form-control" /></td>

        <!-- Editable Phase Select -->
        <td>
          <select
            id="phase_{{ entry.id }}"
            name="phase_{{ entry.id }}"
            required
            class="form-control"
          >
            <option value="">-- Select Phase --</option>
            {% for key, label in entry._meta.get_field('phase').choices %}
            <option value="{{ key }}" {% if key == entry.phase %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </td>

        <td><input type="text" value="{{ entry.billing_consultant.username }}" readonly class="form-control" /></td>
        <td><input type="text" value="{{ entry.last_updated|date:"Y-m-d H:i" }}" readonly class="form-control" /></td>

        <td>
          <input
            id="duration_{{ entry.id }}"
            name="duration_{{ entry.id }}"
            type="number"
            step="0.1"
            min="0"
            max="24"
            value="{{ entry.billing_hours|floatformat:1 }}"
            required
            class="form-control"
          />
        </td>

        <td>
          <textarea
            id="description_{{ entry.id }}"
            name="description_{{ entry.id }}"
            rows="2"
            cols="30"
            required
            class="form-control"
          >{{ entry.work_description }}</textarea>
        </td>

        <td>
          <textarea
            id="remarks_{{ entry.id }}"
            name="remarks_{{ entry.id }}"
            rows="2"
            cols="30"
            class="form-control"
          >{{ entry.comments }}</textarea>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="submit" class="button button-primary" style="margin-top: 1rem;">Save All Entries</button>
</form>
{% else %}
<p>Please select client, project and month and click "Load Timesheet" to see entries.</p>
{% endif %}

{% endblock %}
